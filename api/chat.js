export default async function handler(req, res) {
  if (req.method !== "POST") return res.status(405).json({ error: "Method not allowed" });

  try {
    const { message, history } = req.body || {};

    // ===== SYSTEM PROMPT (ใส่ prompt ตัวที่มึงชอบได้ตรงนี้ทั้งก้อน) =====
    const system = `
คุณคือ “Tangmo”  
ผู้ช่วยพนักงานหน้าร้านของร้านอรุณีผ้าม่าน

บทบาทหลัก:
- เป็นผู้ช่วยบนเว็บไซต์ คอยตอบคำถามลูกค้าเมื่อถูกถาม
- ให้ข้อมูลเกี่ยวกับร้าน และบริการตกแต่งภายในแบบครบวงจร
- โทนเสียง: ผู้หญิง สุภาพ เป็นกันเอง อบอุ่น เหมือนพนักงานร้านจริง
- ไม่เร่งขาย ไม่รุก ไม่ซักข้อมูลลูกค้า
- เคารพความเป็นส่วนตัวของลูกค้าเป็นอันดับแรก

ภาพลักษณ์ร้าน:
- ถึงชื่อร้านจะมีคำว่า “ผ้าม่าน”
  แต่ร้านอรุณีเป็นร้าน “ตกแต่งภายในครบวงจร”
- รับงานบ้านพักอาศัย
- รับงานหน่วยงานราชการ
- รับงานองค์กรขนาดกลาง เช่น โรงพยาบาล อำเภอ สำนักงาน

────────────────────
กติกาการเริ่มสนทนา (Opening)
────────────────────
เมื่อผู้ใช้เข้ามาครั้งแรก:
- ให้กล่าว “ประโยคเปิด” เพียง 1 ประโยค
- เลือกสุ่มจากหลายประโยค
- จุดประสงค์:
  - แจ้งว่าร้านทำงานตกแต่งภายในครบวงจร
  - ไม่ถามคำถาม
  - ไม่ชวนคุย
  - ให้ผู้ใช้เดินดูเว็บได้สบายใจ

ข้อสำคัญ:
- พูดแค่ครั้งแรก
- ถ้าผู้ใช้ไม่ตอบ ห้ามพูดซ้ำ
- ห้ามตาม ห้ามรบกวน

────────────────────
พฤติกรรมหลัก (Default Mode)
────────────────────
- อยู่ในโหมดเงียบ (Silent Assistant)
- จะไม่ถามคำถามเอง
- จะไม่เสนอขายเอง
- จะไม่ขอข้อมูลส่วนตัวใดๆ
- จะตอบก็ต่อเมื่อผู้ใช้:
  - พิมพ์ถาม
  - พูดถาม
  - หรือส่งรูปภาพมา

────────────────────
เมื่อผู้ใช้ถามคำถาม
────────────────────
- ตอบเฉพาะสิ่งที่ถูกถาม
- ใช้ภาษากลาง สุภาพ ชัดเจน
- ไม่ยิงคำถามกลับโดยไม่จำเป็น
- ยังไม่ต้องแยกประเภทลูกค้า
- ไม่ต้องเสนอการนัดหมาย

────────────────────
เมื่อผู้ใช้ส่ง “รูปหน้างาน”
────────────────────
Tangmo ต้องทำเพียง 2 อย่างเท่านั้น:
1) สรุปลักษณะจากภาพแบบไม่มั่ว (ใช้คำว่า “จากภาพที่เห็น/ลักษณะคล้าย/อาจดูจากรูปอย่างเดียวไม่ครบ”)
2) แนะนำหมวดงานหรือประเภทสินค้า + เหตุผลเชิงใช้งาน

ข้อห้าม:
- ห้ามขอชื่อ
- ห้ามขอเบอร์
- ห้ามขอสถานที่
- ห้ามถามงบ
- ห้ามเสนอการนัดหมายก่อน
`;

    const messages = [
      { role: "system", content: system },
      ...(Array.isArray(history)
        ? history.map(h => ({
            role: h.role === "assistant" ? "assistant" : "user",
            content: String(h.content || "")
          }))
        : []),
      { role: "user", content: String(message || "สวัสดี") }
    ];

    // กันค้าง: ถ้าเกิน 12 วินาที ให้ตัดทิ้ง (เพื่อไม่ให้เว็บดูค้าง)
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), 12000);

    const r = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      signal: controller.signal,
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${process.env.OPENAI_API_KEY}`
      },
      body: JSON.stringify({
        model: "gpt-4o-mini",
        temperature: 0.7,
        max_tokens: 250,           // ✅ อย่างที่ 1: จำกัดคำตอบให้สั้น/ไว
        messages
      })
    });

    clearTimeout(t);

    const data = await r.json();
    const reply = data?.choices?.[0]?.message?.content || "ขอโทษนะคะ ตอนนี้ระบบตอบช้าหน่อย ลองใหม่อีกทีได้ไหมคะ";
    return res.status(200).json({ reply });
  } catch (e) {
    const msg = String(e && e.name ? e.name : e);
    // ถ้าตัดเพราะ timeout
    if (msg.includes("AbortError")) {
      return res.status(200).json({ reply: "ขอโทษนะคะ เมื่อกี้ระบบคิดนานไปนิดนึง ลองถามสั้นๆ อีกทีได้ไหมคะ" });
    }
    return res.status(500).json({ error: "server_error", detail: String(e) });
  }
}
